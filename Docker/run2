# IMPORTS
FROM nvidia/cuda:12.1.1-cudnn8-runtime-ubuntu22.04

# SET ENVIRONMENT
ENV DEBIAN_FRONTEND=noninteractive \
    PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1

# MAKE THINGS DETERMINISTIC (optional; ok for repeatability)
ENV CUBLAS_WORKSPACE_CONFIG=:4096:8 \
    CUDNN_DETERMINISTIC=1 \
    PYTORCH_CUDA_ALLOC_CONF=expandable_segments:False \
    CUDA_DEVICE_MAX_CONNECTIONS=1

# INSTALL OS DEPENDANCIES
RUN apt-get update && apt-get install -y --no-install-recommends \
    python3 python3-pip python3-venv \
    git wget curl ca-certificates \
    build-essential \
    nano \
    unzip rsync \
    libglib2.0-0 libgomp1 \
    gnupg \
    && rm -rf /var/lib/apt/lists/*

# INSTALL PYTHON DEPENDANCIES
RUN python3 -m pip install -U pip setuptools wheel

# INSTALL PYTORCH
RUN python3 -m pip install --no-cache-dir \
    torch torchvision torchaudio \
    --index-url https://download.pytorch.org/whl/cu121

# INSTALL CM AUTOMATION
RUN python3 -m pip install --no-cache-dir \
    numpy pyyaml cmind

# CM AUTOMATION
RUN cm pull repo mlcommons@cm4mlops

# (Optional) keep these, but note: CM is currently still cloning master in your logs.
ENV CM_GIT_CHECKOUT=v4.1
RUN git clone -b v4.1 --depth 1 https://github.com/mlcommons/inference.git /opt/mlperf_inference
ENV CM_MLPERF_INFERENCE_SRC=/opt/mlperf_inference

# PATCH: CM tag/type mismatch bug (keep)
RUN python3 - <<'PY'
import pathlib
p = pathlib.Path("/root/CM/repos/mlcommons@cm4mlops/automation/script/module.py")
txt = p.read_text()
txt = txt.replace("','.join(meta['tags'])",
                  "','.join([str(t) for t in meta.get('tags', [])])")
p.write_text(txt)
print("Patched", p)
PY

# PATCH: tolerate submission checker filename changes (THIS FIXES YOUR CRASH)
RUN python3 - <<'PY'
import pathlib, re

p = pathlib.Path("/root/CM/repos/mlcommons@cm4mlops/script/get-mlperf-inference-src/customize.py")
txt = p.read_text()

pattern = r"""shutil\.copy\(\s*os\.path\.join\(submission_checker_dir,\s*"submission-checker\.py"\)\s*,\s*os\.path\.join\(submission_checker_dir,\s*"submission_checker\.py"\)\s*\)"""

replacement = """\
src_hyphen = os.path.join(submission_checker_dir, "submission-checker.py")
src_under  = os.path.join(submission_checker_dir, "submission_checker.py")
dst        = os.path.join(submission_checker_dir, "submission_checker.py")

if os.path.exists(src_hyphen):
    shutil.copy(src_hyphen, dst)
elif os.path.exists(src_under):
    if src_under != dst:
        shutil.copy(src_under, dst)
else:
    raise FileNotFoundError(f"Missing submission checker: {src_hyphen} or {src_under}")
"""

new_txt, n = re.subn(pattern, replacement, txt, count=1)
if n != 1:
    raise RuntimeError("Patch failed: expected submission-checker copy line not found. Upstream file changed.")
p.write_text(new_txt)
print("Patched", p)
PY

# NSIGHT SYSTEM CLI
RUN set -eux; \
    NSYS_DEB="NsightSystems-linux-cli-public-2026.1.1.204-3717666.deb"; \
    curl -fL -o /tmp/nsys.deb "https://developer.download.nvidia.com/devtools/repos/ubuntu2204/amd64/${NSYS_DEB}"; \
    apt-get update; \
    apt-get install -y --no-install-recommends /tmp/nsys.deb; \
    rm -f /tmp/nsys.deb; \
    rm -rf /var/lib/apt/lists/*; \
    nsys --version

WORKDIR /workspace
CMD ["sleep", "infinity"]
